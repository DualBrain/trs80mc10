/*  save.c  */#include <stdio.h>#include <signal.h>#include "sokoban.h"extern char  *malloc();extern char  username[];extern char  map[MAXROW+1][MAXCOL+1];extern short level, moves, pushes, packets, savepack, rows, cols;extern short scoring;extern POS   ppos;static int   savedbn;static char        *sfname;short savegame(){   short ret = 0;   signal( SIGINT, SIG_IGN);   sfname = malloc( strlen( SAVEPATH) + strlen(username) + 6);   sprintf( sfname, "%s/%s.sav", SAVEPATH, username);   if((savedbn = creat(sfname, 0x12)) == -1)      {      if( (savedbn = open(sfname, 2)) == -1)         {         ret = E_FOPENSAVE;         return (ret);         }      }   if( write( savedbn, &(map[0][0]), MAXROW*MAXCOL) != MAXROW*MAXCOL)      ret = E_WRITESAVE;   else if( write( savedbn, &ppos, sizeof( POS)) != sizeof( POS))           ret = E_WRITESAVE;   else if( write( savedbn, &level, 2) != 2)    ret = E_WRITESAVE;   else if( write( savedbn, &moves, 2) != 2)    ret = E_WRITESAVE;   else if( write( savedbn, &pushes, 2) != 2)   ret = E_WRITESAVE;   else if( write( savedbn, &packets, 2) != 2)  ret = E_WRITESAVE;   else if( write( savedbn, &savepack, 2) != 2) ret = E_WRITESAVE;   else if( write( savedbn, &rows, 2) != 2)     ret = E_WRITESAVE;   else if( write( savedbn, &cols, 2) != 2)     ret = E_WRITESAVE;   else      close(savedbn);   if( (ret == E_WRITESAVE) || (ret == E_STATSAVE)) unlink( sfname);   signal( SIGINT, SIG_DFL);   return( ret);}short restoregame() {   short ret = 0;   signal( SIGINT, SIG_IGN);   sfname = malloc( strlen( SAVEPATH) + strlen(username) + 6);   sprintf( sfname, "%s/%s.sav", SAVEPATH, username);   if( (savedbn = open(sfname, 1)) == -1)      ret = E_FOPENSAVE;   else {      if( read( savedbn, &(map[0][0]), MAXROW*MAXCOL) != MAXROW*MAXCOL)         ret = E_READSAVE;      else if( read( savedbn, &ppos, sizeof( POS)) != sizeof( POS))              ret = E_READSAVE;      else if( read( savedbn, &level, 2) != 2)    ret = E_READSAVE;      else if( read( savedbn, &moves, 2) != 2)    ret = E_READSAVE;      else if( read( savedbn, &pushes, 2) != 2)   ret = E_READSAVE;      else if( read( savedbn, &packets, 2) != 2)  ret = E_READSAVE;      else if( read( savedbn, &savepack, 2) != 2) ret = E_READSAVE;      else if( read( savedbn, &rows, 2) != 2)     ret = E_READSAVE;      else if( read( savedbn, &cols, 2) != 2)     ret = E_READSAVE;   }   unlink( sfname);   signal( SIGINT, SIG_DFL);   return( ret);}